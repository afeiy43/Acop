# OpenWrt Builder - robust version
# Replaces cd openwrt/bin/targets/*/* with a safe find+check approach
# Notes: adjust REPO_URL/REPO_BRANCH and secrets as needed

name: OpenWrt Builder

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: 'false'
  UPLOAD_FIRMWARE: 'true'
  UPLOAD_RELEASE: 'true'
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout workflow repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        set -euxo pipefail
        # åˆå§‹æ¸…ç†ï¼šåˆ é™¤å¤§å‹å·¥å…·å’Œ Docker ç¼“å­˜
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL || true
        sudo docker image prune --all --force || true
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev || true
        sudo -E apt-get -qq autoremove --purge -y || true
        sudo -E apt-get -qq clean || true
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir || true

    - name: Clone OpenWrt source
      run: |
        set -euxo pipefail
        # clone source into workspace/openwrt so DIY scripts (in repo root) can reference it via $GITHUB_WORKSPACE
        git clone --depth 1 -b "$REPO_BRANCH" "$REPO_URL" openwrt
      working-directory: ${{ github.workspace }}

    - name: Load custom feeds (part 1)
      run: |
        set -euxo pipefail
        # If user has custom feeds.conf.default in workflow repo root, move it into openwrt
        [ -e "$GITHUB_WORKSPACE/$FEEDS_CONF" ] && mv "$GITHUB_WORKSPACE/$FEEDS_CONF" openwrt/feeds.conf.default || true
        # make sure DIY scripts (if present) are executable
        [ -e "$GITHUB_WORKSPACE/$DIY_P1_SH" ] && chmod +x "$GITHUB_WORKSPACE/$DIY_P1_SH" || true
        if [ -e "$GITHUB_WORKSPACE/$DIY_P1_SH" ]; then
          cd openwrt
          "$GITHUB_WORKSPACE/$DIY_P1_SH"
        fi

    - name: Update feeds
      run: |
        set -euxo pipefail
        cd openwrt
        ./scripts/feeds update -a

    - name: Install feeds
      run: |
        set -euxo pipefail
        cd openwrt
        ./scripts/feeds install -a

    - name: Load custom configuration (part 2)
      run: |
        set -euxo pipefail
        # Move files/ and .config from workflow repo into openwrt if present
        [ -e "$GITHUB_WORKSPACE/files" ] && mv "$GITHUB_WORKSPACE/files" openwrt/files || true
        [ -e "$GITHUB_WORKSPACE/$CONFIG_FILE" ] && mv "$GITHUB_WORKSPACE/$CONFIG_FILE" openwrt/.config || true
        [ -e "$GITHUB_WORKSPACE/$DIY_P2_SH" ] && chmod +x "$GITHUB_WORKSPACE/$DIY_P2_SH" || true
        if [ -e "$GITHUB_WORKSPACE/$DIY_P2_SH" ]; then
          cd openwrt
          "$GITHUB_WORKSPACE/$DIY_P2_SH"
        fi

    - name: Download package
      id: package
      run: |
        set -euxo pipefail
        cd openwrt
        make defconfig
        make download -j8 || true
        # show any tiny/corrupt downloads and remove them
        find dl -size -1024c -exec ls -l {} \; || true
        find dl -size -1024c -exec rm -f {} \; || true

    - name: ğŸ—‘ï¸ Clear OpenWrt Intermediate Files
      run: |
        set -euxo pipefail
        cd openwrt
        echo "æ¸…ç† OpenWrt ä¸­é—´æ„å»ºæ–‡ä»¶å’Œå·¥å…·é“¾..."
        # åˆ é™¤æ‰€æœ‰ä¸­é—´æ„å»ºäº§ç‰©å’Œå·¥å…·é“¾ï¼Œä»…ä¿ç•™ dl ç›®å½•å’Œé…ç½®
        make clean
        # å¯é€‰ï¼šå¦‚æœ dl ç›®å½•å ç”¨å¤ªå¤šç©ºé—´ï¼Œå¯ä»¥æ‰§è¡Œ make dirclean åˆ é™¤ä¸‹è½½çš„æºç åŒ…
        # echo "æ¸…ç† OpenWrt ä¸‹è½½çš„æºç åŒ… (dl)..."
        # make dirclean
        
        echo "æ£€æŸ¥æ¸…ç†åçš„ç£ç›˜ç©ºé—´..."
        df -h

    - name: Compile the firmware
      id: compile
      run: |
        set -euxo pipefail
        cd openwrt
        echo -e "$(nproc) thread compile"
        # try parallel, fallback to single-thread verbose on failure
        if ! make -j$(nproc); then
          make -j1 || make -j1 V=s
        fi

        # if reached here, mark success output
        echo "status=success" >> $GITHUB_OUTPUT

        # capture device name(s) and file date for naming
        grep -E '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME || true
        if [ -s DEVICE_NAME ]; then
          echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        else
          echo "DEVICE_NAME=" >> $GITHUB_ENV
        fi
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

        # debug: list produced bin tree
        ls -la bin || true
        find bin -maxdepth 6 -type f -print || true

    # --- æ–°å¢çš„ç¼–è¯‘åæ¸…ç†æ­¥éª¤ START ---
    - name: ğŸ—‘ï¸ Final Cleanup for Space
      run: |
        set -euxo pipefail
        cd openwrt
        echo "æ¸…ç†ç¼–è¯‘åä¸å†éœ€è¦çš„å·¥å…·é“¾ã€æºç åŒ…å’Œå®Œæ•´çš„IPKåŒ…ç›®å½•..."
        
        # 1. åˆ é™¤ staging_dir ä¸­çš„å·¥å…·é“¾ç›®å½• (æœ€é‡ä¸”ç¼–è¯‘åä¸éœ€è¦)
        rm -rf staging_dir/toolchain-* || true
        
        # 2. åˆ é™¤ dl ç›®å½• (ä¸‹è½½çš„æºç åŒ…)
        rm -rf dl || true
        
        # 3. åˆ é™¤ bin/targets/xxx/packages/ å®Œæ•´çš„è½¯ä»¶åŒ…ç›®å½•
        # è¿™å¯¹äºç”Ÿæˆå›ºä»¶æ˜¯å¤šä½™çš„ï¼Œå¯ä»¥é‡Šæ”¾å¤§é‡ç©ºé—´ã€‚
        find bin/targets -mindepth 2 -maxdepth 4 -type d -name "packages" -exec rm -rf {} + || true
        
        echo "æ¸…ç†åçš„ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
        df -h
    # --- æ–°å¢çš„ç¼–è¯‘åæ¸…ç†æ­¥éª¤ END ---

    - name: Organize files (find target dir & prepare firmware)
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        set -euxo pipefail
        echo "PWD: $(pwd)"
        echo "Listing repo root:"
        ls -la || true
        echo "Listing openwrt top-level:"
        ls -la openwrt || true

        # Ensure bin/targets exists
        if [ ! -d openwrt/bin/targets ]; then
          echo "ERROR: openwrt/bin/targets not found. Dump openwrt tree for debugging:"
          find openwrt -maxdepth 6 -print || true
          exit 1
        fi

        # Find a target directory (typical layout: openwrt/bin/targets/<subtarget>/<profile>)
        TARGET_DIR=$(find openwrt/bin/targets -mindepth 2 -maxdepth 4 -type d | head -n1 || true)
        echo "Located TARGET_DIR=${TARGET_DIR:-<empty>}"

        if [ -z "$TARGET_DIR" ]; then
          echo "ERROR: no target directory found under openwrt/bin/targets"
          find openwrt/bin -maxdepth 5 -print || true
          exit 1
        fi

        # Export firmware dir for later steps and copy to a clean folder for upload
        echo "FIRMWARE=$TARGET_DIR" >> $GITHUB_ENV

        rm -rf firmware || true
        mkdir -p firmware
        cp -a "$TARGET_DIR"/* firmware/ || true
        # optional: remove packages subdir if you don't want to upload it
        # (è¿™è¡Œå¯ä»¥ä¿ç•™ï¼Œä½œä¸ºåŒé‡ä¿éšœï¼Œä½†ä¸Šé¢ Final Cleanup æ­¥éª¤å·²åˆ é™¤ packages ç›®å½•)
        rm -rf firmware/packages || true

        # set success output so upload step knows it's ok
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload bin directory (optional)
      uses: actions/upload-artifact@v4
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: openwrt/bin

    - name: Upload firmware directory
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: firmware

    - name: Generate release tag
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        set -euxo pipefail
        release_tag=$(date +"%Y.%m.%d-%H%M")
        echo "release_tag=${release_tag}" >> $GITHUB_OUTPUT
        # create a simple release body
        echo "OpenWrt build $release_tag" > release.txt
        if [ -n "${{ env.DEVICE_NAME }}" ]; then
          echo "Device:${{ env.DEVICE_NAME }}" >> release.txt || true
        fi
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware to release
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: firmware/*

    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 0
        keep_minimum_runs: 2

    - name: Remove old Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
